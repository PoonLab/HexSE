import os
import random
import unittest
from pprint import pformat
import numpy as np
from Bio import Phylo

from hexse.sequence_info import Sequence
from hexse.simulation import SimulateOnBranch
from hexse.simulation import SimulateOnTree

TEST_TREE = os.path.join(os.path.dirname(__file__), 'fixtures/test_tree.txt')

KAPPA = 0.3
GLOBAL_RATE = 0.0005
CAT_VALUES = {'mu1': 0.051710707633483066, 'mu2': 0.15181054803756722, 'mu3': 0.26809045653750935,
              'mu4': 0.4186255904232465, 'mu5': 0.6442570794470408, 'mu6': 1.2255056178040284}
MAX_DIFF = None


class Seq1(unittest.TestCase):

    def setUp(self):
        self.maxDiff = MAX_DIFF
        random.seed(9001)  # Set seed for pseudo-random number generator

        s1 = 'GTACGATCGATCGATGCTAGC'
        orfs1 = {'+0': [{'coords': [[0, 21]],
                         'omega_classes': 3, 'omega_shape': 1.5,
                         'omega_values': [0.1708353283825978, 0.4810288100937172, 1.1481358615121404],
                         'dn_values': [0.42584203488769556, 1.0711311227395655, 1.7848172815920647,
                              	      2.780153100609863, 5.1880564601470684],
                         'ds_values': [0.6137056388801096, 3.386294361119891],
                         'orf_map': np.array([1])}],
                 '+1': [], '+2': [], '-0': [], '-1': [], '-2': []}
        pi1 = Sequence.get_frequency_rates(s1)
        self.sequence1 = Sequence(s1, orfs1, KAPPA, GLOBAL_RATE, pi1, CAT_VALUES)

        branch_length = 0.1
        self.sim_on_branch1 = SimulateOnBranch(self.sequence1, branch_length)

        phylo_tree = Phylo.read(TEST_TREE, 'newick', rooted=True)
        self.sim_on_tree1 = SimulateOnTree(self.sequence1, phylo_tree)

    @unittest.skip('Attributes probabilyt_tree and select_key are no longer defined')
    def testSelectKey(self):
        from_tree = self.sequence1.probability_tree['to_nt']['G']['from_nt']
        expected = 'A'
        result = self.sim_on_branch1.select_key(from_tree)
        self.assertEqual(expected, result)

        cat_tree = self.sequence1.probability_tree['to_nt']['G']['from_nt']['A']['cat']
        expected = 'mu5'
        result = self.sim_on_branch1.select_key(cat_tree)
        self.assertEqual(expected, result)

    def testGetSubstitution(self):
        random.seed(9001)  # Set seed for pseudo-random number generator
        # GTA CGA TCG ATC GAT GCT AGC
        # Expected GCT --> GAT substitution
        g0 = self.sequence1.nt_sequence[0]
        t1 = self.sequence1.nt_sequence[1]
        a2 = self.sequence1.nt_sequence[2]
        c3 = self.sequence1.nt_sequence[3]
        g4 = self.sequence1.nt_sequence[4]
        a5 = self.sequence1.nt_sequence[5]
        t6 = self.sequence1.nt_sequence[6]
        c7 = self.sequence1.nt_sequence[7]
        g8 = self.sequence1.nt_sequence[8]
        a9 = self.sequence1.nt_sequence[9]
        t10 = self.sequence1.nt_sequence[10]
        c11 = self.sequence1.nt_sequence[11]
        g12 = self.sequence1.nt_sequence[12]
        a13 = self.sequence1.nt_sequence[13]
        t14 = self.sequence1.nt_sequence[14]
        g15 = self.sequence1.nt_sequence[15]
        c16 = self.sequence1.nt_sequence[16]
        t17 = self.sequence1.nt_sequence[17]
        a18 = self.sequence1.nt_sequence[18]
        g19 = self.sequence1.nt_sequence[19]
        c20 = self.sequence1.nt_sequence[20]
        
        expected = ('A', 'G', 'mu6', (1,), (2.9082628030744515,), g15)
        result = self.sim_on_branch1.get_substitution()
        self.assertEqual(expected, result)

    def testWeightedRandomChoice(self):
        # Select to_nucleotide
        random.seed(9001)
        np.random.seed(9001)

        seq1_to_nt_sum = 15.389999999999999
        seq1_to_nt = {'A': 3.5999999999999996, 'C': 3.84, 'T': 3.5999999999999996, 'G': 4.35}

        expected = 'A'
        result = self.sim_on_branch1.weighted_random_choice(seq1_to_nt, seq1_to_nt_sum)
        self.assertEqual(expected, result)

    @unittest.skip('sum_rates is not longer defined')
    def testSumRates(self):
        expected = 0.005388399422550291
        result = self.sim_on_branch1.sum_rates()
        self.assertEqual(expected, result)

    def testMutateOnBranch(self):
        random.seed(9991)
        np.random.seed(9991)
        self.sim_on_branch1.mutate_on_branch(4)
        exp_seq = 'GTACGATCGATCGATGCTAGC'
        exp_res = ''.join(str(nt) for nt in self.sequence1.nt_sequence)
        self.assertEqual(exp_seq, exp_res)

        g0 = self.sequence1.nt_sequence[0]
        t1 = self.sequence1.nt_sequence[1]
        a2 = self.sequence1.nt_sequence[2]
        c3 = self.sequence1.nt_sequence[3]
        g4 = self.sequence1.nt_sequence[4]
        a5 = self.sequence1.nt_sequence[5]
        t6 = self.sequence1.nt_sequence[6]
        c7 = self.sequence1.nt_sequence[7]
        g8 = self.sequence1.nt_sequence[8]
        a9 = self.sequence1.nt_sequence[9]
        t10 = self.sequence1.nt_sequence[10]
        c11 = self.sequence1.nt_sequence[11]
        g12 = self.sequence1.nt_sequence[12]
        a13 = self.sequence1.nt_sequence[13]
        t14 = self.sequence1.nt_sequence[14]
        g15 = self.sequence1.nt_sequence[15]
        c16 = self.sequence1.nt_sequence[16]
        t17 = self.sequence1.nt_sequence[17]
        a18 = self.sequence1.nt_sequence[18]
        g19 = self.sequence1.nt_sequence[19]
        c20 = self.sequence1.nt_sequence[20]

        exp_event_tree = \
            {'to_nt': {'A': {'from_nt': {'A': None,
                                         'C': {'mu1': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1.532074860270361,
                                                              (1.532074860270361,): [c20]}},
                                               'mu2': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1,
                                                              (0.6137056388801096,): [c3]}},
                                               'mu3': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu4': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1,
                                                              (0.6137056388801096,): [c11]}},
                                               'mu5': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 2.9082628030744515,
                                                              (2.9082628030744515,): [c16]}},
                                               'mu6': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'nt_events': 4},
                                         'G': {'mu1': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1,
                                                              (3.386294361119891,): [g8]}},
                                               'mu2': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 2.9082628030744515,
                                                              (2.9082628030744515,): [g4]}},
                                               'mu3': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu5': {'nt_events': 2,
                                                       (1,): {'nt_events': 2,
                                                              'region_weight': 2.0591457794688335,
                                                              (0.5270709191984724,): [g12],
                                                              (1.532074860270361,): [g19]}},
                                               'mu6': {'nt_events': 2,
                                                       (1,): {'nt_events': 2,
                                                              'region_weight': 3.03401738595332,
                                                              (0.12575458287886826,): [g0],
                                                              (2.9082628030744515,): [g15]}},
                                               'nt_events': 6},
                                         'T': {'mu1': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 0.5270709191984724,
                                                              (0.5270709191984724,): [t14]}},
                                               'mu2': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 8.45365616912733,
                                                              (8.45365616912733,): [t10]}},
                                               'mu3': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1,
                                                              (0.6137056388801096,): [t17]}},
                                               'mu4': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 0.12575458287886826,
                                                              (0.12575458287886826,): [t1]}},
                                               'mu5': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1.532074860270361,
                                                              (1.532074860270361,): [t6]}},
                                               'mu6': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'nt_events': 5}},
                             'nt_events': 15},
                       'C': {'from_nt': {'A': {'mu1': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1.532074860270361,
                                                              (1.532074860270361,): [a18]}},
                                               'mu2': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1,
                                                              (3.386294361119891,): [a2]}},
                                               'mu3': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu4': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 0.5270709191984724,
                                                              (0.5270709191984724,): [a13]}},
                                               'mu5': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 8.45365616912733,
                                                              (8.45365616912733,): [a9]}},
                                               'mu6': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1,
                                                              (0.6137056388801096,): [a5]}},
                                               'nt_events': 5},
                                         'C': None,
                                         'G': {'mu1': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu2': {'nt_events': 3,
                                                       (1,): {'nt_events': 3,
                                                              'region_weight': 5.942280189027771,
                                                              (0.12575458287886826,): [g0],
                                                              (2.9082628030744515,): [g4,
                                                                                      g15]}},
                                               'mu3': {'nt_events': 2,
                                                       (1,): {'nt_events': 2,
                                                              'region_weight': 2.0591457794688335,
                                                              (0.5270709191984724,): [g12],
                                                              (1.532074860270361,): [g19]}},
                                               'mu4': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1,
                                                              (3.386294361119891,): [g8]}},
                                               'mu5': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'nt_events': 6},
                                         'T': {'mu1': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu3': {'nt_events': 2,
                                                       (1,): {'nt_events': 2,
                                                              'region_weight': 2.5320748602703613,
                                                              (0.6137056388801096,): [t17],
                                                              (1.532074860270361,): [t6]}},
                                               'mu4': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu5': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1,
                                                              (3.386294361119891,): [t14]}},
                                               'mu6': {'nt_events': 2,
                                                       (1,): {'nt_events': 2,
                                                              'region_weight': 8.579410752006197,
                                                              (0.12575458287886826,): [t1],
                                                              (8.45365616912733,): [t10]}},
                                               'nt_events': 5}},
                             'nt_events': 16},
                       'G': {'from_nt': {'A': {'mu1': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 8.45365616912733,
                                                              (8.45365616912733,): [a9]}},
                                               'mu2': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1,
                                                              (3.386294361119891,): [a2]}},
                                               'mu3': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu4': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1,
                                                              (0.6137056388801096,): [a5]}},
                                               'mu5': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 0.5270709191984724,
                                                              (0.5270709191984724,): [a13]}},
                                               'mu6': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1.532074860270361,
                                                              (1.532074860270361,): [a18]}},
                                               'nt_events': 5},
                                         'C': {'mu1': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu3': {'nt_events': 3,
                                                       (1,): {'nt_events': 3,
                                                              'region_weight': 5.972412523615174,
                                                              (1.532074860270361,): [c7,
                                                                                     c20],
                                                              (2.9082628030744515,): [c3]}},
                                               'mu4': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu5': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 8.45365616912733,
                                                              (8.45365616912733,): [c11]}},
                                               'mu6': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 2.9082628030744515,
                                                              (2.9082628030744515,): [c16]}},
                                               'nt_events': 5},
                                         'G': None,
                                         'T': {'mu1': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 8.45365616912733,
                                                              (8.45365616912733,): [t10]}},
                                               'mu2': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1.532074860270361,
                                                              (1.532074860270361,): [t6]}},
                                               'mu3': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1,
                                                              (0.6137056388801096,): [t17]}},
                                               'mu4': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 0.12575458287886826,
                                                              (0.12575458287886826,): [t1]}},
                                               'mu5': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu6': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 0.5270709191984724,
                                                              (0.5270709191984724,): [t14]}},
                                               'nt_events': 5}},
                             'nt_events': 15},
                       'T': {'from_nt': {'A': {'mu1': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu3': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 0.5270709191984724,
                                                              (0.5270709191984724,): [a13]}},
                                               'mu4': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1,
                                                              (3.386294361119891,): [a2]}},
                                               'mu5': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1,
                                                              (0.6137056388801096,): [a5]}},
                                               'mu6': {'nt_events': 2,
                                                       (1,): {'nt_events': 2,
                                                              'region_weight': 9.98573102939769,
                                                              (1.532074860270361,): [a18],
                                                              (8.45365616912733,): [a9]}},
                                               'nt_events': 5},
                                         'C': {'mu1': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu4': {'nt_events': 2,
                                                       (1,): {'nt_events': 2,
                                                              'region_weight': 2.5320748602703613,
                                                              (1.532074860270361,): [c7],
                                                              (3.386294361119891,): [c20]}},
                                               'mu5': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu6': {'nt_events': 2,
                                                       (1,): {'nt_events': 2,
                                                              'region_weight': 3.9082628030744515,
                                                              (0.6137056388801096,): [c11],
                                                              (2.9082628030744515,): [c16]}},
                                               'nt_events': 4},
                                         'G': {'mu1': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 0.5270709191984724,
                                                              (0.5270709191984724,): [g12]}},
                                               'mu2': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu3': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 2.9082628030744515,
                                                              (2.9082628030744515,): [g15]}},
                                               'mu4': {'nt_events': 2,
                                                       (1,): {'nt_events': 2,
                                                              'region_weight': 4.440337663344812,
                                                              (1.532074860270361,): [g19],
                                                              (2.9082628030744515,): [g4]}},
                                               'mu5': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 0.12575458287886826,
                                                              (0.12575458287886826,): [g0]}},
                                               'mu6': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1,
                                                              (3.386294361119891,): [g8]}},
                                               'nt_events': 6},
                                         'T': None},
                             'nt_events': 15}}}

        self.assertEqual(exp_event_tree, self.sequence1.event_tree)        

    def testRemoveNt(self):
        random.seed(9001)

        g0 = self.sequence1.nt_sequence[0]
        t1 = self.sequence1.nt_sequence[1]
        a2 = self.sequence1.nt_sequence[2]
        c3 = self.sequence1.nt_sequence[3]
        g4 = self.sequence1.nt_sequence[4]
        a5 = self.sequence1.nt_sequence[5]
        t6 = self.sequence1.nt_sequence[6]
        c7 = self.sequence1.nt_sequence[7]
        g8 = self.sequence1.nt_sequence[8]
        a9 = self.sequence1.nt_sequence[9]
        t10 = self.sequence1.nt_sequence[10]
        c11 = self.sequence1.nt_sequence[11]
        g12 = self.sequence1.nt_sequence[12]
        a13 = self.sequence1.nt_sequence[13]
        t14 = self.sequence1.nt_sequence[14]
        g15 = self.sequence1.nt_sequence[15]
        c16 = self.sequence1.nt_sequence[16]
        t17 = self.sequence1.nt_sequence[17]
        a18 = self.sequence1.nt_sequence[18]
        g19 = self.sequence1.nt_sequence[19]
        c20 = self.sequence1.nt_sequence[20]

        self.sim_on_branch1.remove_nt(g0, (1,))

        exp_event_tree = \
            {'to_nt': {'A': {'from_nt': {'A': None,
                                         'C': {'mu1': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1.532074860270361,
                                                              (1.532074860270361,): [c20]}},
                                               'mu2': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1,
                                                              (0.6137056388801096,): [c3]}},
                                               'mu3': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu4': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1,
                                                              (0.6137056388801096,): [c11]}},
                                               'mu5': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 2.9082628030744515,
                                                              (2.9082628030744515,): [c16]}},
                                               'mu6': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'nt_events': 4},
                                         'G': {'mu1': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1,
                                                              (3.386294361119891,): [g8]}},
                                               'mu2': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 2.9082628030744515,
                                                              (2.9082628030744515,): [g4]}},
                                               'mu3': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu5': {'nt_events': 2,
                                                       (1,): {'nt_events': 2,
                                                              'region_weight': 2.0591457794688335,
                                                              (0.5270709191984724,): [g12],
                                                              (1.532074860270361,): [g19]}},
                                               'mu6': {'nt_events': 2,
                                                       (1,): {'nt_events': 2,
                                                              'region_weight': 3.03401738595332,
                                                              (0.12575458287886826,): [],
                                                              (2.9082628030744515,): [g15]}},
                                               'nt_events': 6},
                                         'T': {'mu1': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 0.5270709191984724,
                                                              (0.5270709191984724,): [t14]}},
                                               'mu2': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 8.45365616912733,
                                                              (8.45365616912733,): [t10]}},
                                               'mu3': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1,
                                                              (0.6137056388801096,): [t17]}},
                                               'mu4': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 0.12575458287886826,
                                                              (0.12575458287886826,): [t1]}},
                                               'mu5': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1.532074860270361,
                                                              (1.532074860270361,): [t6]}},
                                               'mu6': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'nt_events': 5}},
                             'nt_events': 15},
                       'C': {'from_nt': {'A': {'mu1': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1.532074860270361,
                                                              (1.532074860270361,): [a18]}},
                                               'mu2': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1,
                                                              (3.386294361119891,): [a2]}},
                                               'mu3': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu4': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 0.5270709191984724,
                                                              (0.5270709191984724,): [a13]}},
                                               'mu5': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 8.45365616912733,
                                                              (8.45365616912733,): [a9]}},
                                               'mu6': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1,
                                                              (0.6137056388801096,): [a5]}},
                                               'nt_events': 5},
                                         'C': None,
                                         'G': {'mu1': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu2': {'nt_events': 3,
                                                       (1,): {'nt_events': 3,
                                                              'region_weight': 5.942280189027771,
                                                              (0.12575458287886826,): [],
                                                              (2.9082628030744515,): [g4,
                                                                                      g15]}},
                                               'mu3': {'nt_events': 2,
                                                       (1,): {'nt_events': 2,
                                                              'region_weight': 2.0591457794688335,
                                                              (0.5270709191984724,): [g12],
                                                              (1.532074860270361,): [g19]}},
                                               'mu4': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1,
                                                              (3.386294361119891,): [g8]}},
                                               'mu5': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'nt_events': 6},
                                         'T': {'mu1': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu3': {'nt_events': 2,
                                                       (1,): {'nt_events': 2,
                                                              'region_weight': 2.5320748602703613,
                                                              (0.6137056388801096,): [t17],
                                                              (1.532074860270361,): [t6]}},
                                               'mu4': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu5': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1,
                                                              (3.386294361119891,): [t14]}},
                                               'mu6': {'nt_events': 2,
                                                       (1,): {'nt_events': 2,
                                                              'region_weight': 8.579410752006197,
                                                              (0.12575458287886826,): [t1],
                                                              (8.45365616912733,): [t10]}},
                                               'nt_events': 5}},
                             'nt_events': 16},
                       'G': {'from_nt': {'A': {'mu1': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 8.45365616912733,
                                                              (8.45365616912733,): [a9]}},
                                               'mu2': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1,
                                                              (3.386294361119891,): [a2]}},
                                               'mu3': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu4': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1,
                                                              (0.6137056388801096,): [a5]}},
                                               'mu5': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 0.5270709191984724,
                                                              (0.5270709191984724,): [a13]}},
                                               'mu6': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1.532074860270361,
                                                              (1.532074860270361,): [a18]}},
                                               'nt_events': 5},
                                         'C': {'mu1': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu3': {'nt_events': 3,
                                                       (1,): {'nt_events': 3,
                                                              'region_weight': 5.972412523615174,
                                                              (1.532074860270361,): [c7,
                                                                                     c20],
                                                              (2.9082628030744515,): [c3]}},
                                               'mu4': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu5': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 8.45365616912733,
                                                              (8.45365616912733,): [c11]}},
                                               'mu6': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 2.9082628030744515,
                                                              (2.9082628030744515,): [c16]}},
                                               'nt_events': 5},
                                         'G': None,
                                         'T': {'mu1': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 8.45365616912733,
                                                              (8.45365616912733,): [t10]}},
                                               'mu2': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1.532074860270361,
                                                              (1.532074860270361,): [t6]}},
                                               'mu3': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1,
                                                              (0.6137056388801096,): [t17]}},
                                               'mu4': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 0.12575458287886826,
                                                              (0.12575458287886826,): [t1]}},
                                               'mu5': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu6': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 0.5270709191984724,
                                                              (0.5270709191984724,): [t14]}},
                                               'nt_events': 5}},
                             'nt_events': 15},
                       'T': {'from_nt': {'A': {'mu1': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu3': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 0.5270709191984724,
                                                              (0.5270709191984724,): [a13]}},
                                               'mu4': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1,
                                                              (3.386294361119891,): [a2]}},
                                               'mu5': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1,
                                                              (0.6137056388801096,): [a5]}},
                                               'mu6': {'nt_events': 2,
                                                       (1,): {'nt_events': 2,
                                                              'region_weight': 9.98573102939769,
                                                              (1.532074860270361,): [a18],
                                                              (8.45365616912733,): [a9]}},
                                               'nt_events': 5},
                                         'C': {'mu1': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu4': {'nt_events': 2,
                                                       (1,): {'nt_events': 2,
                                                              'region_weight': 2.5320748602703613,
                                                              (1.532074860270361,): [c7],
                                                              (3.386294361119891,): [c20]}},
                                               'mu5': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu6': {'nt_events': 2,
                                                       (1,): {'nt_events': 2,
                                                              'region_weight': 3.9082628030744515,
                                                              (0.6137056388801096,): [c11],
                                                              (2.9082628030744515,): [c16]}},
                                               'nt_events': 4},
                                         'G': {'mu1': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 0.5270709191984724,
                                                              (0.5270709191984724,): [g12]}},
                                               'mu2': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu3': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 2.9082628030744515,
                                                              (2.9082628030744515,): [g15]}},
                                               'mu4': {'nt_events': 2,
                                                       (1,): {'nt_events': 2,
                                                              'region_weight': 4.440337663344812,
                                                              (1.532074860270361,): [g19],
                                                              (2.9082628030744515,): [g4]}},
                                               'mu5': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 0.12575458287886826,
                                                              (0.12575458287886826,): []}},
                                               'mu6': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1,
                                                              (3.386294361119891,): [g8]}},
                                               'nt_events': 6},
                                         'T': None},
                             'nt_events': 15}}}      
        self.assertEqual(exp_event_tree, self.sequence1.event_tree)

    def testUpdateNt(self):
        random.seed(9001)
        nt_to_mutate = self.sequence1.nt_sequence[5]
        selected_mutation = self.sim_on_branch1.get_substitution()
        new_state = str(selected_mutation[1])  # A
        self.assertEqual('A', nt_to_mutate.state)
        self.assertEqual('T', nt_to_mutate.get_complement_state())
        expected_rates = {'A': None,
                          'C': 4.4118202240945026e-05,
                          'G': 5.023507085078958e-05,
                          'T': 2.3193254860093468e-05}
        self.assertEqual(expected_rates, nt_to_mutate.rates)                          
        self.sim_on_branch1.update_nucleotide_info(nt_to_mutate, new_state)
        expected_rates = {'A': 0.00017769831458158412,
                          'C': 5.3309494374475237e-05,
                          'G': None,
                          'T': 1.1661934859381657e-05}
        self.assertEqual(expected_rates, nt_to_mutate.rates)
        self.assertEqual('G', nt_to_mutate.state)
        self.assertEqual('C', nt_to_mutate.get_complement_state())
        self.assertEqual(expected_rates, nt_to_mutate.rates)

    def testGetParentClade(self):
        # Label each clade
        ch = 'a'
        for child_clade in self.sim_on_tree1.phylo_tree.find_clades(order='level'):
            child_clade.name = ch
            ch = chr(ord(ch) + 1)

        results = []
        for child_clade in self.sim_on_tree1.phylo_tree.find_clades(order='level'):
            result = self.sim_on_tree1.get_parent_clade(child_clade)
            results.append(result.name)

        expected = ['a', 'a', 'a', 'a', 'd', 'd']
        self.assertEqual(expected, results)

    def testTraverseTree(self):
        random.seed(9001)
        np.random.seed(9001)
        self.sim_on_tree1.traverse_tree(4)

        exp_sequences = ['GTACGATCGATCGATGCTAGC', 'GTACGATCGATCGATGCTAGC', 'GTACGATCGATCGATGCTAGC',
                         'GTACGATCGATCGATGCTAGC', 'GTACGATCGATCGATGCTAGC', 'GTACGATCGATCGATGCTAGC']

        res_sequences = []
        for clade in self.sim_on_tree1.phylo_tree.find_clades(order='level'):
            res_sequences.append(str(clade.sequence))
        self.assertEqual(exp_sequences, res_sequences)

    def testGetAlignment(self):
        expected = '>A \nGTACGATCGATCGATGCTAGC\n>B \nGTACGATCGATCGATGCTAGC\n>C \nGTACGATCGATCGATGCTAGC\n>D \nGTACGATCGATCGATGCTAGC\n'
        outfile = './seq1_output.txt'
        self.sim_on_tree1.get_alignment(outfile)
        with open(outfile) as result_handle:
            result = result_handle.read()
        os.remove(outfile)
        self.assertEqual(expected, result)


class Seq2(unittest.TestCase):

    def setUp(self):
        self.maxDiff = MAX_DIFF
        random.seed(4002)

        s2 = 'ATGAATAAACCCGTATGA'
        orfs2 = {'+0': [{'coords': [[0, 21]],
                         'omega_classes': 3, 'omega_shape': 1.5,
                         'omega_values': [0.1708353283825978, 0.4810288100937172, 1.1481358615121404],
                         'dn_values': [0.13695378264465718, 0.4767518562354524,
                                       0.9999999999999997, 2.3862943611198904],
                         'ds_values': [0.6137056388801096, 3.386294361119891],
                         'orf_map': np.array([1, 0])}],
                 '+1': [], '+2': [], '-0': [], '-1': [],
                 '-2': [{'coords': [[3, 15]],
                         'omega_classes': 4, 'omega_shape': 1.25,
                         'omega_values': [0.13695378264465718, 0.4767518562354524,
                                          0.9999999999999997, 2.3862943611198904], 
                         'dn_values': [1.8965767845633317, 6.103423215436677],
                         'ds_values': [0.6137056388801096, 3.386294361119891],
                         'orf_map': np.array([0, 1])}]}

        pi2 = Sequence.get_frequency_rates(s2)
        self.sequence2 = Sequence(s2, orfs2, KAPPA, GLOBAL_RATE, pi2, CAT_VALUES)

        branch_length = 0.5
        self.sim_on_branch2 = SimulateOnBranch(self.sequence2, branch_length)

        phylo_tree = Phylo.read(TEST_TREE, 'newick', rooted=True)
        self.sim_on_tree2 = SimulateOnTree(self.sequence2, phylo_tree)

    @unittest.skip('Attributes probabilyt_tree and select_key are no longer defined')
    def testSelectKey(self):
        from_tree = self.sequence2.probability_tree['to_nt']['T']['from_nt']
        expected = 'C'
        result = self.sim_on_branch2.select_key(from_tree)
        self.assertEqual(expected, result)

        cat_tree = self.sequence2.probability_tree['to_nt']['G']['from_nt']['A']['cat']
        expected = 'mu4'
        result = self.sim_on_branch2.select_key(cat_tree)
        self.assertEqual(expected, result)

    def testGetSubstitution(self):
        random.seed(4002)
        a0 = self.sequence2.nt_sequence[0]
        t1 = self.sequence2.nt_sequence[1]
        g2 = self.sequence2.nt_sequence[2]
        a3 = self.sequence2.nt_sequence[3]
        a4 = self.sequence2.nt_sequence[4]
        t5 = self.sequence2.nt_sequence[5]
        a6 = self.sequence2.nt_sequence[6]
        a7 = self.sequence2.nt_sequence[7]
        a8 = self.sequence2.nt_sequence[8]
        c9 = self.sequence2.nt_sequence[9]
        c10 = self.sequence2.nt_sequence[10]
        c11 = self.sequence2.nt_sequence[11]
        g12 = self.sequence2.nt_sequence[12]
        t13 = self.sequence2.nt_sequence[13]
        a14 = self.sequence2.nt_sequence[14]
        t15 = self.sequence2.nt_sequence[15]
        g16 = self.sequence2.nt_sequence[16]
        a17 = self.sequence2.nt_sequence[17]
        expected = expected = ('G', 'A', 'mu4', (1, 1), (0.7768412509707903, 0.5600744006011661), a7)
        result = self.sim_on_branch2.get_substitution()
        self.assertEqual(expected, result)

    def testWeightedRandomChoice(self):
        random.seed(4002)
        np.random.seed(4002)

        seq2_to_nt_sum = 3.73
        seq2_to_nt = {'A': 1.32, 'C': 0.51, 'T': 0.88, 'G': 1.02}

        expected = 'G'
        result = self.sim_on_branch2.weighted_random_choice(seq2_to_nt, seq2_to_nt_sum)
        self.assertEqual(expected, result)

    @unittest.skip('sum_rates is not longer defined')
    def testSumRates(self):
        expected = 0.0006784576363843623
        result = self.sim_on_branch2.sum_rates()
        self.assertEqual(expected, result)

    def testMutateOnBranch(self):
        random.seed(9991)
        np.random.seed(9991)
        self.sim_on_branch2.mutate_on_branch(4)
        exp_seq = 'ATGAATAAACCCGTATGA'
        exp_res = ''.join(str(nt) for nt in self.sequence2.nt_sequence)
        self.assertEqual(exp_seq, exp_res)

        a6 = self.sequence2.nt_sequence[6]
        a7 = self.sequence2.nt_sequence[7]
        a8 = self.sequence2.nt_sequence[8]
        c9 = self.sequence2.nt_sequence[9]
        c10 = self.sequence2.nt_sequence[10]
        c11 = self.sequence2.nt_sequence[11]

        exp_event_tree = \
            {'to_nt': {'A': {'from_nt': {'A': None,
                                         'C': {'mu1': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu2': {'nt_events': 2,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 2,
                                                                'region_weight': 0.1133386158870767,
                                                                (0.04044355511945654, 1.8023900359974012): [c10],
                                                                (0.04044355511945654, 3.386294361119891): [c9]}},
                                               'mu3': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu6': {'nt_events': 1,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 1,
                                                                'region_weight': 1.8023900359974012,
                                                                (3.386294361119891, 1.8023900359974012): [c11]}},
                                               'nt_events': 3},
                                         'G': {'mu1': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'nt_events': 0},
                                         'T': {'mu1': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'nt_events': 0}},
                             'nt_events': 3},
                       'C': {'from_nt': {'A': {'mu1': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu2': {'nt_events': 1,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 1,
                                                                'region_weight': 0.4350888979997254,
                                                                (0.7768412509707903, 0.5600744006011661): [a8]}},
                                               'mu3': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu4': {'nt_events': 1,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 1,
                                                                'region_weight': 0.4350888979997254,
                                                                (0.7768412509707903, 0.5600744006011661): [a6]}},
                                               'mu5': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu6': {'nt_events': 1,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 1,
                                                                'region_weight': 0.4350888979997254,
                                                                (0.7768412509707903, 0.5600744006011661): [a7]}},
                                               'nt_events': 3},
                                         'C': None,
                                         'G': {'mu1': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'nt_events': 0},
                                         'T': {'mu1': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'nt_events': 0}},
                             'nt_events': 3},
                       'G': {'from_nt': {'A': {'mu1': {'nt_events': 1,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 1,
                                                                'region_weight': 0.5600744006011661,
                                                                (0.6137056388801096, 0.5600744006011661): [a8]}},
                                               'mu2': {'nt_events': 1,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 1,
                                                                'region_weight': 0.7768412509707903,
                                                                (0.7768412509707903, 3.386294361119891): [a6]}},
                                               'mu3': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu4': {'nt_events': 1,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 1,
                                                                'region_weight': 0.4350888979997254,
                                                                (0.7768412509707903, 0.5600744006011661): [a7]}},
                                               'mu5': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'nt_events': 3},
                                         'C': {'mu1': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu2': {'nt_events': 1,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 1,
                                                                'region_weight': 0.07289506076762016,
                                                                (0.04044355511945654, 1.8023900359974012): [c10]}},
                                               'mu3': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu4': {'nt_events': 2,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 2,
                                                                'region_weight': 1.8428335911168578,
                                                                (0.04044355511945654, 3.386294361119891): [c9],
                                                                (3.386294361119891, 1.8023900359974012): [c11]}},
                                               'mu5': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'nt_events': 3},
                                         'G': None,
                                         'T': {'mu1': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'nt_events': 0}},
                             'nt_events': 6},
                       'T': {'from_nt': {'A': {'mu1': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu5': {'nt_events': 1,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 1,
                                                                'region_weight': 0.4350888979997254,
                                                                (0.7768412509707903, 0.5600744006011661): [a7]}},
                                               'mu6': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'nt_events': 1},
                                         'C': {'mu1': {'nt_events': 2,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 2,
                                                                'region_weight': 0.1133386158870767,
                                                                (0.04044355511945654, 1.8023900359974012): [c10],
                                                                (0.04044355511945654, 3.386294361119891): [c9]}},
                                               'mu2': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu4': {'nt_events': 1,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 1,
                                                                'region_weight': 1.8023900359974012,
                                                                (3.386294361119891, 1.8023900359974012): [c11]}},
                                               'mu5': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'nt_events': 3},
                                         'G': {'mu1': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'nt_events': 0},
                                         'T': None},
                             'nt_events': 4}}}        
        
        self.assertEqual(exp_event_tree, self.sequence2.event_tree)

    def testRemoveNt(self):
        random.seed(9001)

        a6 = self.sequence2.nt_sequence[6]
        a7 = self.sequence2.nt_sequence[7]
        a8 = self.sequence2.nt_sequence[8]
        c9 = self.sequence2.nt_sequence[9]
        c10 = self.sequence2.nt_sequence[10]
        c11 = self.sequence2.nt_sequence[11]

        self.sim_on_branch2.remove_nt(c11, (1, 1))

        exp_event_tree = \
            {'to_nt': {'A': {'from_nt': {'A': None,
                                         'C': {'mu1': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu2': {'nt_events': 2,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 2,
                                                                'region_weight': 0.1133386158870767,
                                                                (0.04044355511945654, 1.8023900359974012): [c10],
                                                                (0.04044355511945654, 3.386294361119891): [c9]}},
                                               'mu3': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu6': {'nt_events': 1,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 1,
                                                                'region_weight': 1.8023900359974012,
                                                                (3.386294361119891, 1.8023900359974012): []}},
                                               'nt_events': 3},
                                         'G': {'mu1': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'nt_events': 0},
                                         'T': {'mu1': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'nt_events': 0}},
                             'nt_events': 3},
                       'C': {'from_nt': {'A': {'mu1': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu2': {'nt_events': 1,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 1,
                                                                'region_weight': 0.4350888979997254,
                                                                (0.7768412509707903, 0.5600744006011661): [a8]}},
                                               'mu3': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu4': {'nt_events': 1,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 1,
                                                                'region_weight': 0.4350888979997254,
                                                                (0.7768412509707903, 0.5600744006011661): [a6]}},
                                               'mu5': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu6': {'nt_events': 1,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 1,
                                                                'region_weight': 0.4350888979997254,
                                                                (0.7768412509707903, 0.5600744006011661): [a7]}},
                                               'nt_events': 3},
                                         'C': None,
                                         'G': {'mu1': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'nt_events': 0},
                                         'T': {'mu1': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'nt_events': 0}},
                             'nt_events': 3},
                       'G': {'from_nt': {'A': {'mu1': {'nt_events': 1,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 1,
                                                                'region_weight': 0.5600744006011661,
                                                                (0.6137056388801096, 0.5600744006011661): [a8]}},
                                               'mu2': {'nt_events': 1,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 1,
                                                                'region_weight': 0.7768412509707903,
                                                                (0.7768412509707903, 3.386294361119891): [a6]}},
                                               'mu3': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu4': {'nt_events': 1,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 1,
                                                                'region_weight': 0.4350888979997254,
                                                                (0.7768412509707903, 0.5600744006011661): [a7]}},
                                               'mu5': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'nt_events': 3},
                                         'C': {'mu1': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu2': {'nt_events': 1,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 1,
                                                                'region_weight': 0.07289506076762016,
                                                                (0.04044355511945654, 1.8023900359974012): [c10]}},
                                               'mu3': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu4': {'nt_events': 2,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 2,
                                                                'region_weight': 1.8428335911168578,
                                                                (0.04044355511945654, 3.386294361119891): [c9],
                                                                (3.386294361119891, 1.8023900359974012): []}},
                                               'mu5': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'nt_events': 3},
                                         'G': None,
                                         'T': {'mu1': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'nt_events': 0}},
                             'nt_events': 6},
                       'T': {'from_nt': {'A': {'mu1': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu5': {'nt_events': 1,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 1,
                                                                'region_weight': 0.4350888979997254,
                                                                (0.7768412509707903, 0.5600744006011661): [a7]}},
                                               'mu6': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'nt_events': 1},
                                         'C': {'mu1': {'nt_events': 2,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 2,
                                                                'region_weight': 0.1133386158870767,
                                                                (0.04044355511945654, 1.8023900359974012): [c10],
                                                                (0.04044355511945654, 3.386294361119891): [c9]}},
                                               'mu2': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu4': {'nt_events': 1,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 1,
                                                                'region_weight': 1.8023900359974012,
                                                                (3.386294361119891, 1.8023900359974012): []}},
                                               'mu5': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'nt_events': 3},
                                         'G': {'mu1': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'nt_events': 0},
                                         'T': None},
                             'nt_events': 4}}}
        
        self.assertEqual(exp_event_tree, self.sequence2.event_tree)

    def testUpdateNt(self):
        random.seed(4002)
        nt_to_mutate = self.sequence2.nt_sequence[9]
        selected_mutation = self.sim_on_branch2.get_substitution()
        new_state = str(selected_mutation[1])  # A
        self.sim_on_branch2.update_nucleotide_info(nt_to_mutate, new_state)

        expected_rates = {'A': None,
                          'C': 1.3803008039309775e-07,
                          'G': 1.0904036880629392e-05,
                          'T': 7.156070562943518e-07}

        self.assertEqual('A', nt_to_mutate.state)
        self.assertEqual('T', nt_to_mutate.get_complement_state())
        self.assertEqual(expected_rates, nt_to_mutate.rates)

    def testGetParentClade(self):
        # Label each clade
        ch = 'a'
        for child_clade in self.sim_on_tree2.phylo_tree.find_clades(order='level'):
            child_clade.name = ch
            ch = chr(ord(ch) + 1)

        results = []
        for child_clade in self.sim_on_tree2.phylo_tree.find_clades(order='level'):
            result = self.sim_on_tree2.get_parent_clade(child_clade)
            results.append(result.name)

        expected = ['a', 'a', 'a', 'a', 'd', 'd']
        self.assertEqual(expected, results)

    def testTraverseTree(self):
        random.seed(9001)
        np.random.seed(9001)
        self.sim_on_tree2.traverse_tree(4)

        exp_sequences = ['ATGAATAAACCCGTATGA', 'ATGAATAAACCCGTATGA', 'ATGAATAAACCCGTATGA', 'ATGAATAAACCCGTATGA',
                         'ATGAATAAACCCGTATGA', 'ATGAATAAACCCGTATGA']

        res_sequences = []
        for clade in self.sim_on_tree2.phylo_tree.find_clades(order='level'):
            res_sequences.append(str(clade.sequence))
        self.assertEqual(exp_sequences, res_sequences)

    def testGetAlignment(self):
        expected = '>A \nATGAATAAACCCGTATGA\n>B \nATGAATAAACCCGTATGA\n>C \nATGAATAAACCCGTATGA\n>D \nATGAATAAACCCGTATGA\n'
        outfile = './seq2_output.txt'
        self.sim_on_tree2.get_alignment(outfile)
        with open(outfile) as result_handle:
            result = result_handle.read()
        os.remove(outfile)
        self.assertEqual(expected, result)


class Seq3(unittest.TestCase):

    def setUp(self):
        self.maxDiff = MAX_DIFF
        random.seed(987)

        s3 = 'ATGACGTGGTGA'
        orfs3 = {'+0': [{'coords': [[0, 12]],
                         'omega_classes': 3, 'omega_shape': 1.5,
                         'omega_values': [0.1708353283825978, 0.4810288100937172, 1.1481358615121404],
                         'dn_values': [0.42584203488769556, 1.0711311227395655, 1.7848172815920647,
                                       2.780153100609863, 5.1880564601470684],
                         'ds_values': [0.6137056388801096, 3.386294361119891],
                         'orf_map': np.array([1])}],
                 '+1': [], '+2': [], '-0': [], '-1': [], '-2': []}

        pi3 = Sequence.get_frequency_rates(s3)
        self.sequence3 = Sequence(s3, orfs3, KAPPA, GLOBAL_RATE, pi3, CAT_VALUES)

        branch_length = 0.1
        self.sim_on_branch3 = SimulateOnBranch(self.sequence3, branch_length)

        phylo_tree = Phylo.read(TEST_TREE, 'newick', rooted=True)
        self.sim_on_tree3 = SimulateOnTree(self.sequence3, phylo_tree)

    @unittest.skip('Attributes probabilyt_tree and select_key are no longer defined')
    def testSelectKey(self):
        from_tree = self.sequence3.probability_tree['to_nt']['G']['from_nt']
        expected = 'T'
        result = self.sim_on_branch3.select_key(from_tree)
        self.assertEqual(expected, result)

        cat_tree = self.sequence3.probability_tree['to_nt']['G']['from_nt']['A']['cat']
        expected = 'mu6'
        result = self.sim_on_branch3.select_key(cat_tree)
        self.assertEqual(expected, result)

    def testGetSubstitution(self):
        a0 = self.sequence3.nt_sequence[0]
        t1 = self.sequence3.nt_sequence[1]
        g2 = self.sequence3.nt_sequence[2]
        a3 = self.sequence3.nt_sequence[3]
        c4 = self.sequence3.nt_sequence[4]
        g5 = self.sequence3.nt_sequence[5]
        t6 = self.sequence3.nt_sequence[6]
        g7 = self.sequence3.nt_sequence[7]
        g8 = self.sequence3.nt_sequence[8]
        t9 = self.sequence3.nt_sequence[9]
        g10 = self.sequence3.nt_sequence[10]
        a11 = self.sequence3.nt_sequence[11]

        expected = ('A', 'G', 'mu3', (1,), (0.6137056388801096,), g5)
        result = self.sim_on_branch3.get_substitution()
        self.assertEqual(expected, result)

    def testWeightedRandomChoice(self):
        seq3_to_nt_sum = 3.66
        seq3_to_nt = {'A': 0.75, 'C': 0.4, 'T': 1.25, 'G': 1.26}

        expected = 'A'
        result = self.sim_on_branch3.weighted_random_choice(seq3_to_nt, seq3_to_nt_sum)
        self.assertEqual(expected, result)

    @unittest.skip('sum_rates is not longer defined')
    def testSumRates(self):
        expected = 0.0007782992106999442
        result = self.sim_on_branch3.sum_rates()
        self.assertEqual(expected, result)

    def testMutateOnBranch(self):
        random.seed(9991)
        np.random.seed(9991)
        self.sim_on_branch3.mutate_on_branch(4)
        exp_seq = 'ATGACGTGGTGA'
        exp_res = ''.join(str(nt) for nt in self.sequence3.nt_sequence)
        self.assertEqual(exp_seq, exp_res)

        a3 = self.sequence3.nt_sequence[3]
        c4 = self.sequence3.nt_sequence[4]
        g5 = self.sequence3.nt_sequence[5]
        t6 = self.sequence3.nt_sequence[6]
        g7 = self.sequence3.nt_sequence[7]
        g8 = self.sequence3.nt_sequence[8]

        exp_event_tree = \
            {'to_nt': {'A': {'from_nt': {'A': None,
                                         'C': {'mu1': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu6': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 0.693886462677404,
                                                              (0.693886462677404,): [c4]}},
                                               'nt_events': 1},
                                         'G': {'mu1': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu3': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1,
                                                              (0.6137056388801096,): [g5]}},
                                               'mu4': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'nt_events': 1},
                                         'T': {'mu1': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu2': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 2.9082628030744515,
                                                              (2.9082628030744515,): [t6]}},
                                               'mu3': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'nt_events': 1}},
                             'nt_events': 3},
                       'C': {'from_nt': {'A': {'mu1': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu6': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 0.693886462677404,
                                                              (0.693886462677404,): [a3]}},
                                               'nt_events': 1},
                                         'C': None,
                                         'G': {'mu1': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 2.9082628030744515,
                                                              (2.9082628030744515,): [g8]}},
                                               'mu2': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu6': {'nt_events': 2,
                                                       (1,): {'nt_events': 2,
                                                              'region_weight': 3.9082628030744515,
                                                              (0.6137056388801096,): [g5],
                                                              (2.9082628030744515,): [g7]}},
                                               'nt_events': 3},
                                         'T': {'mu1': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 2.9082628030744515,
                                                              (2.9082628030744515,): [t6]}},
                                               'mu2': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'nt_events': 1}},
                             'nt_events': 5},
                       'G': {'from_nt': {'A': {'mu1': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu6': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 0.693886462677404,
                                                              (0.693886462677404,): [a3]}},
                                               'nt_events': 1},
                                         'C': {'mu1': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu6': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 0.693886462677404,
                                                              (0.693886462677404,): [c4]}},
                                               'nt_events': 1},
                                         'G': None,
                                         'T': {'mu1': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu5': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 2.9082628030744515,
                                                              (2.9082628030744515,): [t6]}},
                                               'mu6': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'nt_events': 1}},
                             'nt_events': 3},
                       'T': {'from_nt': {'A': {'mu1': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu6': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 0.693886462677404,
                                                              (0.693886462677404,): [a3]}},
                                               'nt_events': 1},
                                         'C': {'mu1': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu2': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 0.693886462677404,
                                                              (0.693886462677404,): [c4]}},
                                               'mu3': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'nt_events': 1},
                                         'G': {'mu1': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu2': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 2.9082628030744515,
                                                              (2.9082628030744515,): [g7]}},
                                               'mu3': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu4': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1,
                                                              (0.6137056388801096,): [g5]}},
                                               'mu5': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 2.9082628030744515,
                                                              (2.9082628030744515,): [g8]}},
                                               'mu6': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'nt_events': 3},
                                         'T': None},
                             'nt_events': 5}}}

        self.assertEqual(exp_event_tree, self.sequence3.event_tree)

    def testRemoveNt(self):
        random.seed(9001)

        a3 = self.sequence3.nt_sequence[3]
        c4 = self.sequence3.nt_sequence[4]
        g5 = self.sequence3.nt_sequence[5]
        t6 = self.sequence3.nt_sequence[6]
        g7 = self.sequence3.nt_sequence[7]
        g8 = self.sequence3.nt_sequence[8]

        self.sim_on_branch3.remove_nt(a3, (1,))

        exp_event_tree = \
            {'to_nt': {'A': {'from_nt': {'A': None,
                                         'C': {'mu1': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu6': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 0.693886462677404,
                                                              (0.693886462677404,): [c4]}},
                                               'nt_events': 1},
                                         'G': {'mu1': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu3': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1,
                                                              (0.6137056388801096,): [g5]}},
                                               'mu4': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'nt_events': 1},
                                         'T': {'mu1': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu2': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 2.9082628030744515,
                                                              (2.9082628030744515,): [t6]}},
                                               'mu3': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'nt_events': 1}},
                             'nt_events': 3},
                       'C': {'from_nt': {'A': {'mu1': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu6': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 0.693886462677404,
                                                              (0.693886462677404,): []}},
                                               'nt_events': 1},
                                         'C': None,
                                         'G': {'mu1': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 2.9082628030744515,
                                                              (2.9082628030744515,): [g8]}},
                                               'mu2': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu6': {'nt_events': 2,
                                                       (1,): {'nt_events': 2,
                                                              'region_weight': 3.9082628030744515,
                                                              (0.6137056388801096,): [g5],
                                                              (2.9082628030744515,): [g7]}},
                                               'nt_events': 3},
                                         'T': {'mu1': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 2.9082628030744515,
                                                              (2.9082628030744515,): [t6]}},
                                               'mu2': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'nt_events': 1}},
                             'nt_events': 5},
                       'G': {'from_nt': {'A': {'mu1': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu6': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 0.693886462677404,
                                                              (0.693886462677404,): []}},
                                               'nt_events': 1},
                                         'C': {'mu1': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu6': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 0.693886462677404,
                                                              (0.693886462677404,): [c4]}},
                                               'nt_events': 1},
                                         'G': None,
                                         'T': {'mu1': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu5': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 2.9082628030744515,
                                                              (2.9082628030744515,): [t6]}},
                                               'mu6': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'nt_events': 1}},
                             'nt_events': 3},
                       'T': {'from_nt': {'A': {'mu1': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu6': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 0.693886462677404,
                                                              (0.693886462677404,): []}},
                                               'nt_events': 1},
                                         'C': {'mu1': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu2': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 0.693886462677404,
                                                              (0.693886462677404,): [c4]}},
                                               'mu3': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'nt_events': 1},
                                         'G': {'mu1': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu2': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 2.9082628030744515,
                                                              (2.9082628030744515,): [g7]}},
                                               'mu3': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu4': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1,
                                                              (0.6137056388801096,): [g5]}},
                                               'mu5': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 2.9082628030744515,
                                                              (2.9082628030744515,): [g8]}},
                                               'mu6': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'nt_events': 3},
                                         'T': None},
                             'nt_events': 5}}}

        self.assertEqual(exp_event_tree, self.sequence3.event_tree)

    def testUpdateNt(self):
        random.seed(987)
        nt_to_mutate = self.sequence3.nt_sequence[6]
        selected_mutation = self.sim_on_branch3.get_substitution()
        new_state = str(selected_mutation[1])  # A
        self.sim_on_branch3.update_nucleotide_info(nt_to_mutate, new_state)

        expected_rates = {'A': 6.205284916017968e-07,
                          'C': None,
                          'G': 5.2980596396640475e-06,
                          'T': 6.0155331012446764e-06}

        self.assertEqual('C', nt_to_mutate.state)
        self.assertEqual('G', nt_to_mutate.get_complement_state())
        self.assertEqual(expected_rates, nt_to_mutate.rates)

    def testGetParentClade(self):
        # Label each clade
        ch = 'a'
        for child_clade in self.sim_on_tree3.phylo_tree.find_clades(order='level'):
            child_clade.name = ch
            ch = chr(ord(ch) + 1)

        results = []
        for child_clade in self.sim_on_tree3.phylo_tree.find_clades(order='level'):
            result = self.sim_on_tree3.get_parent_clade(child_clade)
            results.append(result.name)

        expected = ['a', 'a', 'a', 'a', 'd', 'd']
        self.assertEqual(expected, results)

    def testTraverseTree(self):
        random.seed(9001)
        np.random.seed(9001)
        self.sim_on_tree3.traverse_tree(4)

        exp_sequences = ['ATGACGTGGTGA', 'ATGACGTGGTGA', 'ATGACGTGGTGA', 'ATGACGTGGTGA', 'ATGACGTGGTGA', 'ATGACGTGGTGA']

        res_sequences = []
        for clade in self.sim_on_tree3.phylo_tree.find_clades(order='level'):
            res_sequences.append(str(clade.sequence))
        self.assertEqual(exp_sequences, res_sequences)

    def testGetAlignment(self):
        expected = '>A \nATGACGTGGTGA\n>B \nATGACGTGGTGA\n>C \nATGACGTGGTGA\n>D \nATGACGTGGTGA\n'
        outfile = './seq3_output.txt'
        self.sim_on_tree3.get_alignment(outfile)
        with open(outfile) as result_handle:
            result = result_handle.read()
        os.remove(outfile)
        self.assertEqual(expected, result)


class Seq4(unittest.TestCase):

    def setUp(self):
        self.maxDiff = MAX_DIFF
        random.seed(9001)

        s4 = 'ATGATGCCCTAA'
        orfs4 = {'+0': [{'coords': [[0, 12]],
                         'omega_classes': 3, 'omega_shape': 1.5, 
                         'omega_values': [0.1708353283825978, 0.4810288100937172, 1.1481358615121404],
                         'dn_values': [0.3329677267246186, 1.0887942245237032, 2.8982380487141928],
                         'ds_values': [0.6137056388801096, 3.386294361119891],
                         'orf_map': np.array([1])}],
                 '+1': [], '+2': [], '-0': [], '-1': [], '-2': []}
        pi4 = Sequence.get_frequency_rates(s4)
        self.sequence4 = Sequence(s4, orfs4, KAPPA, GLOBAL_RATE, pi4, CAT_VALUES)

        branch_length = 0.0075
        self.sim_on_branch4 = SimulateOnBranch(self.sequence4, branch_length)

        phylo_tree = Phylo.read(TEST_TREE, 'newick', rooted=True)
        self.sim_on_tree4 = SimulateOnTree(self.sequence4, phylo_tree)

    @unittest.skip('Attributes probabilyt_tree and select_key are no longer defined')
    def testSelectKey(self):
        from_tree = self.sequence4.probability_tree['to_nt']['T']['from_nt']
        expected = 'C'
        result = self.sim_on_branch4.select_key(from_tree)
        self.assertEqual(expected, result)

        cat_tree = self.sequence4.probability_tree['to_nt']['T']['from_nt']['C']['cat']
        expected = 'mu5'
        result = self.sim_on_branch4.select_key(cat_tree)
        self.assertEqual(expected, result)

    def testGetSubstitution(self):
        random.seed(9001)
        a0 = self.sequence4.nt_sequence[0]
        t1 = self.sequence4.nt_sequence[1]
        g2 = self.sequence4.nt_sequence[2]
        a3 = self.sequence4.nt_sequence[3]
        t4 = self.sequence4.nt_sequence[4]
        g5 = self.sequence4.nt_sequence[5]
        c6 = self.sequence4.nt_sequence[6]
        c7 = self.sequence4.nt_sequence[7]
        c8 = self.sequence4.nt_sequence[8]
        t9 = self.sequence4.nt_sequence[9]
        a10 = self.sequence4.nt_sequence[10]
        a11 = self.sequence4.nt_sequence[11]
        expected = ('A', 'C', 'mu5', (1,), (0.8558730398605124,), c6)
        result = self.sim_on_branch4.get_substitution()
        self.assertEqual(expected, result)

    def testWeightedRandomChoice(self):
        seq4_to_nt_sum = 3.66
        seq4_to_nt = {'A': 0.75, 'C': 0.4, 'T': 1.25, 'G': 1.26}

        expected = 'G'
        result = self.sim_on_branch4.weighted_random_choice(seq4_to_nt, seq4_to_nt_sum)
        self.assertEqual(expected, result)

    @unittest.skip('sum_rates is not longer defined')
    def testSumRates(self):
        expected = 0.0015468750983061975
        result = self.sim_on_branch4.sum_rates()
        self.assertEqual(expected, result)

    def testMutateOnBranch(self):
        random.seed(9991)
        np.random.seed(9991)
        self.sim_on_branch4.mutate_on_branch(4)
        exp_seq = 'ATGATGCCCTAA'
        exp_res = ''.join(str(nt) for nt in self.sequence4.nt_sequence)
        self.assertEqual(exp_seq, exp_res)

        a3 = self.sequence4.nt_sequence[3]
        t4 = self.sequence4.nt_sequence[4]
        g5 = self.sequence4.nt_sequence[5]
        c6 = self.sequence4.nt_sequence[6]
        c7 = self.sequence4.nt_sequence[7]
        c8 = self.sequence4.nt_sequence[8]

        exp_event_tree = \
            {'to_nt': {'A': {'from_nt': {'A': None,
                                         'C': {'mu1': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu2': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1,
                                                              (3.386294361119891,): [c8]}},
                                               'mu3': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu5': {'nt_events': 2,
                                                       (1,): {'nt_events': 2,
                                                              'region_weight': 1.7117460797210249,
                                                              (0.8558730398605124,): [c6,
                                                                                      c7]}},
                                               'mu6': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'nt_events': 3},
                                         'G': {'mu1': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu6': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1.774131041895811,
                                                              (1.774131041895811,): [g5]}},
                                               'nt_events': 1},
                                         'T': {'mu1': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu5': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1.774131041895811,
                                                              (1.774131041895811,): [t4]}},
                                               'mu6': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'nt_events': 1}},
                             'nt_events': 5},
                       'C': {'from_nt': {'A': {'mu1': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu6': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1.774131041895811,
                                                              (1.774131041895811,): [a3]}},
                                               'nt_events': 1},
                                         'C': None,
                                         'G': {'mu1': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu3': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1.774131041895811,
                                                              (1.774131041895811,): [g5]}},
                                               'mu4': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'nt_events': 1},
                                         'T': {'mu1': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu6': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1.774131041895811,
                                                              (1.774131041895811,): [t4]}},
                                               'nt_events': 1}},
                             'nt_events': 3},
                       'G': {'from_nt': {'A': {'mu1': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu6': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1.774131041895811,
                                                              (1.774131041895811,): [a3]}},
                                               'nt_events': 1},
                                         'C': {'mu1': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu4': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 0.8558730398605124,
                                                              (0.8558730398605124,): [c7]}},
                                               'mu5': {'nt_events': 2,
                                                       (1,): {'nt_events': 2,
                                                              'region_weight': 1.8558730398605126,
                                                              (0.8558730398605124,): [c6],
                                                              (3.386294361119891,): [c8]}},
                                               'mu6': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'nt_events': 3},
                                         'G': None,
                                         'T': {'mu1': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu5': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1.774131041895811,
                                                              (1.774131041895811,): [t4]}},
                                               'mu6': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'nt_events': 1}},
                             'nt_events': 5},
                       'T': {'from_nt': {'A': {'mu1': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu3': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1.774131041895811,
                                                              (1.774131041895811,): [a3]}},
                                               'mu4': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'nt_events': 1},
                                         'C': {'mu1': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 0.8558730398605124,
                                                              (0.8558730398605124,): [c6]}},
                                               'mu2': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu4': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1,
                                                              (3.386294361119891,): [c8]}},
                                               'mu5': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu6': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 0.8558730398605124,
                                                              (0.8558730398605124,): [c7]}},
                                               'nt_events': 3},
                                         'G': {'mu1': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu3': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1.774131041895811,
                                                              (1.774131041895811,): [g5]}},
                                               'mu4': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'nt_events': 1},
                                         'T': None},
                             'nt_events': 5}}}

        self.assertEqual(exp_event_tree, self.sequence4.event_tree)

    def testRemoveNt(self):
        random.seed(9001)

        a3 = self.sequence4.nt_sequence[3]
        t4 = self.sequence4.nt_sequence[4]
        g5 = self.sequence4.nt_sequence[5]
        c6 = self.sequence4.nt_sequence[6]
        c7 = self.sequence4.nt_sequence[7]
        c8 = self.sequence4.nt_sequence[8]

        self.sim_on_branch4.remove_nt(c7, (1,))

        exp_event_tree = \
            {'to_nt': {'A': {'from_nt': {'A': None,
                                         'C': {'mu1': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu2': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1,
                                                              (3.386294361119891,): [c8]}},
                                               'mu3': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu5': {'nt_events': 2,
                                                       (1,): {'nt_events': 2,
                                                              'region_weight': 1.7117460797210249,
                                                              (0.8558730398605124,): [c6]}},
                                               'mu6': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'nt_events': 3},
                                         'G': {'mu1': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu6': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1.774131041895811,
                                                              (1.774131041895811,): [g5]}},
                                               'nt_events': 1},
                                         'T': {'mu1': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu5': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1.774131041895811,
                                                              (1.774131041895811,): [t4]}},
                                               'mu6': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'nt_events': 1}},
                             'nt_events': 5},
                       'C': {'from_nt': {'A': {'mu1': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu6': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1.774131041895811,
                                                              (1.774131041895811,): [a3]}},
                                               'nt_events': 1},
                                         'C': None,
                                         'G': {'mu1': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu3': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1.774131041895811,
                                                              (1.774131041895811,): [g5]}},
                                               'mu4': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'nt_events': 1},
                                         'T': {'mu1': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu6': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1.774131041895811,
                                                              (1.774131041895811,): [t4]}},
                                               'nt_events': 1}},
                             'nt_events': 3},
                       'G': {'from_nt': {'A': {'mu1': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu6': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1.774131041895811,
                                                              (1.774131041895811,): [a3]}},
                                               'nt_events': 1},
                                         'C': {'mu1': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu4': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 0.8558730398605124,
                                                              (0.8558730398605124,): []}},
                                               'mu5': {'nt_events': 2,
                                                       (1,): {'nt_events': 2,
                                                              'region_weight': 1.8558730398605126,
                                                              (0.8558730398605124,): [c6],
                                                              (3.386294361119891,): [c8]}},
                                               'mu6': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'nt_events': 3},
                                         'G': None,
                                         'T': {'mu1': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu5': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1.774131041895811,
                                                              (1.774131041895811,): [t4]}},
                                               'mu6': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'nt_events': 1}},
                             'nt_events': 5},
                       'T': {'from_nt': {'A': {'mu1': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu3': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1.774131041895811,
                                                              (1.774131041895811,): [a3]}},
                                               'mu4': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'nt_events': 1},
                                         'C': {'mu1': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 0.8558730398605124,
                                                              (0.8558730398605124,): [c6]}},
                                               'mu2': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu4': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1,
                                                              (3.386294361119891,): [c8]}},
                                               'mu5': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu6': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 0.8558730398605124,
                                                              (0.8558730398605124,): []}},
                                               'nt_events': 3},
                                         'G': {'mu1': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu3': {'nt_events': 1,
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1.774131041895811,
                                                              (1.774131041895811,): [g5]}},
                                               'mu4': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'nt_events': 1},
                                         'T': None},
                             'nt_events': 5}}}

        self.assertEqual(exp_event_tree, self.sequence4.event_tree)

    def testUpdateNt(self):
        random.seed(9001)

        nt_to_mutate = self.sequence4.nt_sequence[6]
        selected_mutation = self.sim_on_branch4.get_substitution()
        new_state = str(selected_mutation[1])  # A
        self.sim_on_branch4.update_nucleotide_info(nt_to_mutate, new_state)

        expected_rates = {'A': 3.933289569285259e-05,
                          'C': None,
                          'G': 3.933289569285259e-05,
                          'T': 2.8681424249293843e-05}

        self.assertEqual('C', nt_to_mutate.state)
        self.assertEqual('G', nt_to_mutate.get_complement_state())
        self.assertEqual(expected_rates, nt_to_mutate.rates)

    def testGetParentClade(self):
        # Label each clade
        ch = 'a'
        for child_clade in self.sim_on_tree4.phylo_tree.find_clades(order='level'):
            child_clade.name = ch
            ch = chr(ord(ch) + 1)

        results = []
        for child_clade in self.sim_on_tree4.phylo_tree.find_clades(order='level'):
            result = self.sim_on_tree4.get_parent_clade(child_clade)
            results.append(result.name)

        expected = ['a', 'a', 'a', 'a', 'd', 'd']
        self.assertEqual(expected, results)

    def testTraverseTree(self):
        random.seed(9001)
        np.random.seed(9001)
        self.sim_on_tree4.traverse_tree(4)

        exp_sequences = ['ATGATGCCCTAA', 'ATGATGCCCTAA', 'ATGATGCCCTAA', 'ATGATGCCCTAA', 'ATGATGCCCTAA', 'ATGATGCCCTAA']

        res_sequences = []
        for clade in self.sim_on_tree4.phylo_tree.find_clades(order='level'):
            res_sequences.append(str(clade.sequence))
        self.assertEqual(exp_sequences, res_sequences)

    def testGetAlignment(self):
        expected = '>A \nATGATGCCCTAA\n>B \nATGATGCCCTAA\n>C \nATGATGCCCTAA\n>D \nATGATGCCCTAA\n'
        outfile = './seq4_output.txt'
        self.sim_on_tree4.get_alignment(outfile)
        with open(outfile) as result_handle:
            result = result_handle.read()
        os.remove(outfile)
        self.assertEqual(expected, result)


class Seq5(unittest.TestCase):

    def setUp(self):
        self.maxDiff = MAX_DIFF
        random.seed(121)

        s5 = 'ATGAATGCCTGACTAA'
        orfs5 = {'+0': [{'coords': [[0, 12]],
                         'omega_classes': 3, 'omega_shape': 1.5,
                         'omega_values': [0.1708353283825978, 0.4810288100937172, 1.1481358615121404],
                         'dn_values': [0.13695378264465718, 0.4767518562354524,
                                       0.9999999999999997, 2.3862943611198904],
                         'ds_values': [0.6137056388801096, 3.386294361119891],
                         'orf_map': np.array([1, 0])}],
                 '+1': [{'coords': [[4, 16]],
                         'omega_classes': 4, 'omega_shape': 1.25,
                         'omega_values': [0.09199853806558903, 0.27043066909631136,
                                          0.5158061369385518, 1.1217646558655263],
                         'dn_values': [0.13695378264465718, 0.4767518562354524,
                                       0.9999999999999997, 2.3862943611198904],
                         'ds_values': [0.6137056388801096, 3.386294361119891],
                         'orf_map': np.array([0, 1])}],
                 '+2': [], '-0': [], '-1': [], '-2': []}
                 
        pi5 = Sequence.get_frequency_rates(s5)
        self.sequence5 = Sequence(s5, orfs5, KAPPA, GLOBAL_RATE, pi5, CAT_VALUES)

        branch_length = 0.00057
        self.sim_on_branch5 = SimulateOnBranch(self.sequence5, branch_length)

        phylo_tree = Phylo.read(TEST_TREE, 'newick', rooted=True)
        self.sim_on_tree5 = SimulateOnTree(self.sequence5, phylo_tree)

    @unittest.skip('Attributes probabilyt_tree and select_key are no longer defined')
    def testSelectKey(self):
        from_tree = self.sequence5.probability_tree['to_nt']['A']['from_nt']
        expected = 'C'
        result = self.sim_on_branch5.select_key(from_tree)
        self.assertEqual(expected, result)

        cat_tree = self.sequence5.probability_tree['to_nt']['A']['from_nt']['C']['cat']
        expected = 'mu5'
        result = self.sim_on_branch5.select_key(cat_tree)
        self.assertEqual(expected, result)

    def testGetSubstitution(self):
        random.seed(121)
        a0 = self.sequence5.nt_sequence[0]
        t1 = self.sequence5.nt_sequence[1]
        g2 = self.sequence5.nt_sequence[2]
        a3 = self.sequence5.nt_sequence[3]
        a4 = self.sequence5.nt_sequence[4]
        t5 = self.sequence5.nt_sequence[5]
        g6 = self.sequence5.nt_sequence[6]
        c7 = self.sequence5.nt_sequence[7]
        c8 = self.sequence5.nt_sequence[8]
        t9 = self.sequence5.nt_sequence[9]
        g10 = self.sequence5.nt_sequence[10]
        a11 = self.sequence5.nt_sequence[11]
        c12 = self.sequence5.nt_sequence[12]
        t13 = self.sequence5.nt_sequence[13]
        a14 = self.sequence5.nt_sequence[14]
        a15 = self.sequence5.nt_sequence[15]
        expected = ('A', 'C', 'mu2', (1, 1), (0.140788663179826, 3.888337029906392), c7)
        result = self.sim_on_branch5.get_substitution()
        self.assertEqual(expected, result)

    def testWeightedRandomChoice(self):
        seq5_to_nt_sum = 3.09
        seq5_to_nt = {'A': 1.1400000000000001, 'C': 0.19, 'T': 1.0, 'G': 0.76}

        expected = 'T'
        result = self.sim_on_branch5.weighted_random_choice(seq5_to_nt, seq5_to_nt_sum)
        self.assertEqual(expected, result)

    @unittest.skip('sum_rates is not longer defined')
    def testSumRates(self):
        expected = 0.0012649456821425343
        result = self.sim_on_branch5.sum_rates()
        self.assertEqual(expected, result)

    def testMutateOnBranch(self):
        random.seed(9991)
        np.random.seed(9991)
        self.sim_on_branch5.mutate_on_branch(4)
        exp_seq = 'ATGAATGCCTGACTAA'
        exp_res = ''.join(str(nt) for nt in self.sequence5.nt_sequence)
        self.assertEqual(exp_seq, exp_res)

        a3 = self.sequence5.nt_sequence[3]
        c7 = self.sequence5.nt_sequence[7]
        c8 = self.sequence5.nt_sequence[8]
        c12 = self.sequence5.nt_sequence[12]

        exp_event_tree = \
            {'to_nt': {'A': {'from_nt': {'A': None,
                                         'C': {'mu1': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu2': {'nt_events': 2,
                                                       (0, 1): {'nt_events': 1,
                                                                'region_weight': 0.04044355511945654,
                                                                (None, 0.04044355511945654): [c12]},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 1,
                                                                'region_weight': 0.5474337724331361,
                                                                (0.140788663179826, 3.888337029906392): [c7]}},
                                               'mu3': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu4': {'nt_events': 1,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 1,
                                                                'region_weight': 3.888337029906392,
                                                                (3.386294361119891, 3.888337029906392): [c8]}},
                                               'mu5': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'nt_events': 3},
                                         'G': {'mu1': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'nt_events': 0},
                                         'T': {'mu1': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'nt_events': 0}},
                             'nt_events': 3},
                       'C': {'from_nt': {'A': {'mu1': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu4': {'nt_events': 1,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 1,
                                                                'region_weight': 3.888337029906392,
                                                                (3.888337029906392, None): [a3]},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'nt_events': 1},
                                         'C': None,
                                         'G': {'mu1': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'nt_events': 0},
                                         'T': {'mu1': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'nt_events': 0}},
                             'nt_events': 1},
                       'G': {'from_nt': {'A': {'mu1': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu5': {'nt_events': 1,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 1,
                                                                'region_weight': 3.888337029906392,
                                                                (3.888337029906392, None): [a3]},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'nt_events': 1},
                                         'C': {'mu1': {'nt_events': 1,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 1,
                                                                'region_weight': 3.888337029906392,
                                                                (3.386294361119891, 3.888337029906392): [c8]}},
                                               'mu2': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu3': {'nt_events': 1,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 1,
                                                                'region_weight': 0.5474337724331361,
                                                                (0.140788663179826, 3.888337029906392): [c7]}},
                                               'mu4': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu6': {'nt_events': 1,
                                                       (0, 1): {'nt_events': 1,
                                                                'region_weight': 0.04044355511945654,
                                                                (None, 0.04044355511945654): [c12]},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'nt_events': 3},
                                         'G': None,
                                         'T': {'mu1': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'nt_events': 0}},
                             'nt_events': 4},
                       'T': {'from_nt': {'A': {'mu1': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu2': {'nt_events': 1,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 1,
                                                                'region_weight': 3.888337029906392,
                                                                (3.888337029906392, None): [a3]},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'nt_events': 1},
                                         'C': {'mu1': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu2': {'nt_events': 1,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 1,
                                                                'region_weight': 0.5474337724331361,
                                                                (0.140788663179826, 3.888337029906392): [c7]}},
                                               'mu3': {'nt_events': 1,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 1,
                                                                'region_weight': 3.888337029906392,
                                                                (3.386294361119891, 3.888337029906392): [c8]}},
                                               'mu4': {'nt_events': 1,
                                                       (0, 1): {'nt_events': 1,
                                                                'region_weight': 1,
                                                                (None, 3.386294361119891): [c12]},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'nt_events': 3},
                                         'G': {'mu1': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'nt_events': 0},
                                         'T': None},
                             'nt_events': 4}}}
        
        self.assertEqual(exp_event_tree, self.sequence5.event_tree)

    def testRemoveNt(self):
        random.seed(9001)

        a3 = self.sequence5.nt_sequence[3]
        c7 = self.sequence5.nt_sequence[7]
        c8 = self.sequence5.nt_sequence[8]
        c12 = self.sequence5.nt_sequence[12]

        self.sim_on_branch5.remove_nt(c12, (0, 1))

        exp_event_tree = \
            {'to_nt': {'A': {'from_nt': {'A': None,
                                         'C': {'mu1': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu2': {'nt_events': 2,
                                                       (0, 1): {'nt_events': 1,
                                                                'region_weight': 0.04044355511945654,
                                                                (None, 0.04044355511945654): []},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 1,
                                                                'region_weight': 0.5474337724331361,
                                                                (0.140788663179826, 3.888337029906392): [c7]}},
                                               'mu3': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu4': {'nt_events': 1,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 1,
                                                                'region_weight': 3.888337029906392,
                                                                (3.386294361119891, 3.888337029906392): [c8]}},
                                               'mu5': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'nt_events': 3},
                                         'G': {'mu1': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'nt_events': 0},
                                         'T': {'mu1': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'nt_events': 0}},
                             'nt_events': 3},
                       'C': {'from_nt': {'A': {'mu1': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu4': {'nt_events': 1,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 1,
                                                                'region_weight': 3.888337029906392,
                                                                (3.888337029906392, None): [a3]},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'nt_events': 1},
                                         'C': None,
                                         'G': {'mu1': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'nt_events': 0},
                                         'T': {'mu1': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'nt_events': 0}},
                             'nt_events': 1},
                       'G': {'from_nt': {'A': {'mu1': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu5': {'nt_events': 1,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 1,
                                                                'region_weight': 3.888337029906392,
                                                                (3.888337029906392, None): [a3]},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'nt_events': 1},
                                         'C': {'mu1': {'nt_events': 1,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 1,
                                                                'region_weight': 3.888337029906392,
                                                                (3.386294361119891, 3.888337029906392): [c8]}},
                                               'mu2': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu3': {'nt_events': 1,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 1,
                                                                'region_weight': 0.5474337724331361,
                                                                (0.140788663179826, 3.888337029906392): [c7]}},
                                               'mu4': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu6': {'nt_events': 1,
                                                       (0, 1): {'nt_events': 1,
                                                                'region_weight': 0.04044355511945654,
                                                                (None, 0.04044355511945654): []},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'nt_events': 3},
                                         'G': None,
                                         'T': {'mu1': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'nt_events': 0}},
                             'nt_events': 4},
                       'T': {'from_nt': {'A': {'mu1': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu2': {'nt_events': 1,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 1,
                                                                'region_weight': 3.888337029906392,
                                                                (3.888337029906392, None): [a3]},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'nt_events': 1},
                                         'C': {'mu1': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu2': {'nt_events': 1,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 1,
                                                                'region_weight': 0.5474337724331361,
                                                                (0.140788663179826, 3.888337029906392): [c7]}},
                                               'mu3': {'nt_events': 1,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 1,
                                                                'region_weight': 3.888337029906392,
                                                                (3.386294361119891, 3.888337029906392): [c8]}},
                                               'mu4': {'nt_events': 1,
                                                       (0, 1): {'nt_events': 1,
                                                                'region_weight': 1,
                                                                (None, 3.386294361119891): []},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'nt_events': 3},
                                         'G': {'mu1': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (0, 1): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 0): {'nt_events': 0,
                                                                'region_weight': 0},
                                                       (1, 1): {'nt_events': 0,
                                                                'region_weight': 0}},
                                               'nt_events': 0},
                                         'T': None},
                             'nt_events': 4}}}      
        self.assertEqual(exp_event_tree, self.sequence5.event_tree)

    def testUpdateNt(self):
        random.seed(121)
        nt_to_mutate = self.sequence5.nt_sequence[8]
        selected_mutation = self.sim_on_branch5.get_substitution()
        new_state = str(selected_mutation[1])  # A
        self.sim_on_branch5.update_nucleotide_info(nt_to_mutate, new_state)

        expected_rates = {'A': 2.9709142411300275e-05,
                          'C': None,
                          'G': 2.9709142411300275e-05,
                          'T': 5.60776046691613e-05}

        self.assertEqual('C', nt_to_mutate.state)
        self.assertEqual('G', nt_to_mutate.get_complement_state())
        self.assertEqual(expected_rates, nt_to_mutate.rates)

    def testGetParentClade(self):
        # Label each clade
        ch = 'a'
        for child_clade in self.sim_on_tree5.phylo_tree.find_clades(order='level'):
            child_clade.name = ch
            ch = chr(ord(ch) + 1)

        results = []
        for child_clade in self.sim_on_tree5.phylo_tree.find_clades(order='level'):
            result = self.sim_on_tree5.get_parent_clade(child_clade)
            results.append(result.name)

        expected = ['a', 'a', 'a', 'a', 'd', 'd']
        self.assertEqual(expected, results)

    def testTraverseTree(self):
        random.seed(9001)
        np.random.seed(9001)
        self.sim_on_tree5.traverse_tree(4)

        exp_sequences = ['ATGAATGCCTGACTAA', 'ATGAATGCCTGACTAA', 'ATGAATGCCTGACTAA', 'ATGAATGCCTGACTAA',
                         'ATGAATGCCTGACTAA', 'ATGAATGCCTGACTAA']

        res_sequences = []
        for clade in self.sim_on_tree5.phylo_tree.find_clades(order='level'):
            res_sequences.append(str(clade.sequence))
        self.assertEqual(exp_sequences, res_sequences)

    def testGetAlignment(self):
        expected = '>A \nATGAATGCCTGACTAA\n>B \nATGAATGCCTGACTAA\n>C \nATGAATGCCTGACTAA\n>D \nATGAATGCCTGACTAA\n'
        outfile = './seq5_output.txt'
        self.sim_on_tree5.get_alignment(outfile)
        with open(outfile) as result_handle:
            result = result_handle.read()
        os.remove(outfile)
        self.assertEqual(expected, result)


class Seq6(unittest.TestCase):

    def setUp(self):
        self.maxDiff = MAX_DIFF
        random.seed(4675)

        s6 = 'ATGATGGCCCTAA'
        orfs6 = {'+0': [{'coords': [(0, 5), (6, 13)],
                         'omega_classes': 3, 'omega_shape': 1.5,
                         'omega_values': [0.1708353283825978, 0.4810288100937172, 1.1481358615121404],
                         'dn_values': [0.3329677267246186, 1.0887942245237032, 2.8982380487141928],
                         'ds_values': [0.6137056388801096, 3.386294361119891],
                         'orf_map': np.array([1])}], 
                 '+1': [], '+2': [], '-0': [], '-1': [], '-2': []}
        pi6 = Sequence.get_frequency_rates(s6)
        self.sequence6 = Sequence(s6, orfs6, KAPPA, GLOBAL_RATE, pi6, CAT_VALUES)

        branch_length = 0.00087
        self.sim_on_branch6 = SimulateOnBranch(self.sequence6, branch_length)

        phylo_tree = Phylo.read(TEST_TREE, 'newick', rooted=True)
        self.sim_on_tree6 = SimulateOnTree(self.sequence6, phylo_tree)

    @unittest.skip('Attributes probabilyt_tree and select_key are no longer defined')
    def testSelectKey(self):
        from_tree = self.sequence6.probability_tree['to_nt']['C']['from_nt']
        expected = 'T'
        result = self.sim_on_branch6.select_key(from_tree)
        self.assertEqual(expected, result)

        cat_tree = self.sequence6.probability_tree['to_nt']['C']['from_nt']['T']['cat']
        expected = 'mu3'
        result = self.sim_on_branch6.select_key(cat_tree)
        self.assertEqual(expected, result)

    def testGetSubstitution(self):
        random.seed(4675)
        a0 = self.sequence6.nt_sequence[0]
        t1 = self.sequence6.nt_sequence[1]
        g2 = self.sequence6.nt_sequence[2]
        a3 = self.sequence6.nt_sequence[3]
        t4 = self.sequence6.nt_sequence[4]
        g5 = self.sequence6.nt_sequence[5]
        g6 = self.sequence6.nt_sequence[6]
        c7 = self.sequence6.nt_sequence[7]
        c8 = self.sequence6.nt_sequence[8]
        c9 = self.sequence6.nt_sequence[9]
        t10 = self.sequence6.nt_sequence[10]
        a11 = self.sequence6.nt_sequence[11]
        a12 = self.sequence6.nt_sequence[12]
        expected = ('T', 'G', 'mu6', (1,), (4.722521458337745,), g6)
        result = self.sim_on_branch6.get_substitution()
        self.assertEqual(expected, result)

    def testWeightedRandomChoice(self):
        seq6_to_nt_sum = 4.540000000000001
        seq6_to_nt = {'A': 1.55, 'C': 0.6900000000000001, 'T': 1.1500000000000001, 'G': 1.1500000000000001}

        expected = 'C'
        result = self.sim_on_branch6.weighted_random_choice(seq6_to_nt, seq6_to_nt_sum)
        self.assertEqual(expected, result)

    @unittest.skip('sum_rates is not longer defined')
    def testSumRates(self):
        expected = 0.0010196410449064004
        result = self.sim_on_branch6.sum_rates()
        self.assertEqual(expected, result)

    def testMutateOnBranch(self):
        random.seed(9991)
        np.random.seed(9991)
        self.sim_on_branch6.mutate_on_branch(20000)
        exp_seq = 'ATGAACTAAATAA'
        exp_res = ''.join(str(nt) for nt in self.sequence6.nt_sequence)
        self.assertEqual(exp_seq, exp_res)

        a3 = self.sequence6.nt_sequence[3]
        a4 = self.sequence6.nt_sequence[4]
        c5 = self.sequence6.nt_sequence[5]
        t6 = self.sequence6.nt_sequence[6]
        a7 = self.sequence6.nt_sequence[7]
        a8 = self.sequence6.nt_sequence[8]
        a9 = self.sequence6.nt_sequence[9]

        exp_event_tree = \
            {'to_nt': {'A': {'from_nt': {'A': None,
                                         'C': {'mu1': {'nt_events': 1,
                                                       (0,): {'nt_events': 1,
                                                              'region_weight': 1,
                                                              (None,): [c5]},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0.0,
                                                              (0.5425528227705685,): []}},
                                               'mu2': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0.0,
                                                              (0.5425528227705685,): [],
                                                              (0.6137056388801096,): []}},
                                               'mu3': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0.0,
                                                              (0.5425528227705685,): []}},
                                               'mu4': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0.0,
                                                              (0.5425528227705685,): []}},
                                               'mu5': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0,
                                                              (0.6137056388801096,): []}},
                                               'mu6': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0.0,
                                                              (0.6137056388801096,): [],
                                                              (4.722521458337745,): []}},
                                               'nt_events': 1},
                                         'G': {'mu1': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0,
                                                              (None,): []},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0.0,
                                                              (0.5425528227705685,): []}},
                                               'mu2': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0.0,
                                                              (4.722521458337745,): []}},
                                               'mu4': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0,
                                                              (None,): []},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'nt_events': 0},
                                         'T': {'mu1': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0.0,
                                                              (4.722521458337745,): []}},
                                               'mu2': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0.0,
                                                              (4.722521458337745,): []}},
                                               'mu3': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0.0,
                                                              (0.5425528227705685,): []}},
                                               'mu4': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0,
                                                              (None,): []},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0.0,
                                                              (4.722521458337745,): []}},
                                               'mu5': {'nt_events': 1,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 4.722521458337745,
                                                              (4.722521458337745,): [t6]}},
                                               'mu6': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'nt_events': 1}},
                             'nt_events': 2},
                       'C': {'from_nt': {'A': {'mu1': {'nt_events': 3,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 3,
                                                              'region_weight': 9.987595739446059,
                                                              (0.5425528227705685,): [a9],
                                                              (0.6137056388801096,): [],
                                                              (4.722521458337745,): [a3,
                                                                                     a4]}},
                                               'mu2': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0.0,
                                                              (0.6137056388801096,): [],
                                                              (4.722521458337745,): []}},
                                               'mu3': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0,
                                                              (None,): []},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0.0,
                                                              (4.722521458337745,): []}},
                                               'mu4': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu5': {'nt_events': 1,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 0.5425528227705685,
                                                              (0.5425528227705685,): [a8],
                                                              (0.6137056388801096,): []}},
                                               'mu6': {'nt_events': 1,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 0.5425528227705685,
                                                              (0.5425528227705685,): [a7],
                                                              (4.722521458337745,): []}},
                                               'nt_events': 5},
                                         'C': None,
                                         'G': {'mu1': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0.0,
                                                              (0.5425528227705685,): [],
                                                              (4.722521458337745,): []}},
                                               'mu2': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0,
                                                              (None,): []},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0.0,
                                                              (4.722521458337745,): []}},
                                               'mu5': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0,
                                                              (None,): []},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'nt_events': 0},
                                         'T': {'mu1': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0.0,
                                                              (0.5425528227705685,): []}},
                                               'mu2': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0.0,
                                                              (0.6137056388801096,): [],
                                                              (4.722521458337745,): []}},
                                               'mu3': {'nt_events': 1,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1.0,
                                                              (0.6137056388801096,): [t6],
                                                              (4.722521458337745,): []}},
                                               'mu4': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0,
                                                              (None,): []},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'nt_events': 1}},
                             'nt_events': 6},
                       'G': {'from_nt': {'A': {'mu1': {'nt_events': 1,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1.0,
                                                              (0.5425528227705685,): [],
                                                              (0.6137056388801096,): [a9],
                                                              (4.722521458337745,): []}},
                                               'mu2': {'nt_events': 1,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 4.722521458337745,
                                                              (0.5425528227705685,): [],
                                                              (0.6137056388801096,): [],
                                                              (4.722521458337745,): [a3]}},
                                               'mu3': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0.0,
                                                              (0.5425528227705685,): []}},
                                               'mu4': {'nt_events': 2,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 2,
                                                              'region_weight': 1.085105645541137,
                                                              (0.5425528227705685,): [a8,
                                                                                      a7],
                                                              (4.722521458337745,): []}},
                                               'mu5': {'nt_events': 1,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0,
                                                              (None,): []},
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 4.722521458337745,
                                                              (4.722521458337745,): [a4]}},
                                               'mu6': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0.0,
                                                              (0.5425528227705685,): [],
                                                              (0.6137056388801096,): [],
                                                              (4.722521458337745,): []}},
                                               'nt_events': 5},
                                         'C': {'mu1': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0.0,
                                                              (0.6137056388801096,): [],
                                                              (4.722521458337745,): []}},
                                               'mu2': {'nt_events': 1,
                                                       (0,): {'nt_events': 1,
                                                              'region_weight': 1,
                                                              (None,): [c5]},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0.0,
                                                              (0.5425528227705685,): []}},
                                               'mu3': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0.0,
                                                              (0.5425528227705685,): [],
                                                              (4.722521458337745,): []}},
                                               'mu4': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0,
                                                              (0.6137056388801096,): []}},
                                               'mu6': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'nt_events': 1},
                                         'G': None,
                                         'T': {'mu1': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0.0,
                                                              (4.722521458337745,): []}},
                                               'mu2': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0,
                                                              (None,): []},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0.0,
                                                              (0.5425528227705685,): [],
                                                              (4.722521458337745,): []}},
                                               'mu3': {'nt_events': 1,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 4.722521458337745,
                                                              (4.722521458337745,): [t6]}},
                                               'mu4': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0.0,
                                                              (4.722521458337745,): []}},
                                               'mu5': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'nt_events': 1}},
                             'nt_events': 7},
                       'T': {'from_nt': {'A': {'mu1': {'nt_events': 1,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 0.5425528227705685,
                                                              (0.5425528227705685,): [a8]}},
                                               'mu2': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0.0,
                                                              (0.5425528227705685,): [],
                                                              (4.722521458337745,): []}},
                                               'mu3': {'nt_events': 1,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0,
                                                              (None,): []},
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 0.5425528227705685,
                                                              (0.5425528227705685,): [a9],
                                                              (0.6137056388801096,): [],
                                                              (4.722521458337745,): []}},
                                               'mu4': {'nt_events': 1,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 4.722521458337745,
                                                              (4.722521458337745,): [a4]}},
                                               'mu5': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0.0,
                                                              (0.5425528227705685,): [],
                                                              (4.722521458337745,): []}},
                                               'mu6': {'nt_events': 1,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 4.722521458337745,
                                                              (4.722521458337745,): [a3]}},
                                               'nt_events': 4},
                                         'C': {'mu1': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0.0,
                                                              (0.5425528227705685,): [],
                                                              (0.6137056388801096,): []}},
                                               'mu2': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0.0,
                                                              (0.5425528227705685,): [],
                                                              (0.6137056388801096,): []}},
                                               'mu3': {'nt_events': 1,
                                                       (0,): {'nt_events': 1,
                                                              'region_weight': 1,
                                                              (None,): [c5]},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0,
                                                              (0.6137056388801096,): []}},
                                               'mu5': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0.0,
                                                              (0.5425528227705685,): []}},
                                               'mu6': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'nt_events': 1},
                                         'G': {'mu1': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0,
                                                              (None,): []},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0.0,
                                                              (4.722521458337745,): []}},
                                               'mu3': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0,
                                                              (None,): []},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0.0,
                                                              (0.5425528227705685,): []}},
                                               'mu6': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0.0,
                                                              (4.722521458337745,): []}},
                                               'nt_events': 0},
                                         'T': None},
                             'nt_events': 5}}}

        self.assertEqual(exp_event_tree, self.sequence6.event_tree)

    def testRemoveNt(self):
        random.seed(9001)

        a3 = self.sequence6.nt_sequence[3]
        t4 = self.sequence6.nt_sequence[4]
        g5 = self.sequence6.nt_sequence[5]
        g6 = self.sequence6.nt_sequence[6]
        c7 = self.sequence6.nt_sequence[7]
        c8 = self.sequence6.nt_sequence[8]
        c9 = self.sequence6.nt_sequence[9]

        self.sim_on_branch6.remove_nt(t4, (1,))

        exp_event_tree = \
            {'to_nt': {'A': {'from_nt': {'A': None,
                                         'C': {'mu1': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu3': {'nt_events': 1,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 0.5425528227705685,
                                                              (0.5425528227705685,): [c8]}},
                                               'mu4': {'nt_events': 1,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 0.5425528227705685,
                                                              (0.5425528227705685,): [c7]}},
                                               'mu5': {'nt_events': 1,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1,
                                                              (0.6137056388801096,): [c9]}},
                                               'mu6': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'nt_events': 3},
                                         'G': {'mu1': {'nt_events': 1,
                                                       (0,): {'nt_events': 1,
                                                              'region_weight': 1,
                                                              (None,): [g5]},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu3': {'nt_events': 1,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 4.722521458337745,
                                                              (4.722521458337745,): [g6]}},
                                               'mu4': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'nt_events': 2},
                                         'T': {'mu1': {'nt_events': 1,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 4.722521458337745,
                                                              (4.722521458337745,): []}},
                                               'mu2': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'nt_events': 1}},
                             'nt_events': 6},
                       'C': {'from_nt': {'A': {'mu1': {'nt_events': 1,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 4.722521458337745,
                                                              (4.722521458337745,): [a3]}},
                                               'mu2': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'nt_events': 1},
                                         'C': None,
                                         'G': {'mu1': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu3': {'nt_events': 1,
                                                       (0,): {'nt_events': 1,
                                                              'region_weight': 1,
                                                              (None,): [g5]},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu4': {'nt_events': 1,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 4.722521458337745,
                                                              (4.722521458337745,): [g6]}},
                                               'mu5': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'nt_events': 2},
                                         'T': {'mu1': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu3': {'nt_events': 1,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 4.722521458337745,
                                                              (4.722521458337745,): []}},
                                               'mu4': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'nt_events': 1}},
                             'nt_events': 4},
                       'G': {'from_nt': {'A': {'mu1': {'nt_events': 1,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 4.722521458337745,
                                                              (4.722521458337745,): [a3]}},
                                               'mu2': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'nt_events': 1},
                                         'C': {'mu1': {'nt_events': 1,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1,
                                                              (0.6137056388801096,): [c9]}},
                                               'mu2': {'nt_events': 1,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 0.5425528227705685,
                                                              (0.5425528227705685,): [c8]}},
                                               'mu3': {'nt_events': 1,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 0.5425528227705685,
                                                              (0.5425528227705685,): [c7]}},
                                               'mu4': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'nt_events': 3},
                                         'G': None,
                                         'T': {'mu1': {'nt_events': 1,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 4.722521458337745,
                                                              (4.722521458337745,): []}},
                                               'mu2': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu6': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'nt_events': 1}},
                             'nt_events': 5},
                       'T': {'from_nt': {'A': {'mu1': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu6': {'nt_events': 1,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 4.722521458337745,
                                                              (4.722521458337745,): [a3]}},
                                               'nt_events': 1},
                                         'C': {'mu1': {'nt_events': 1,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 0.5425528227705685,
                                                              (0.5425528227705685,): [c8]}},
                                               'mu2': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu4': {'nt_events': 1,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 1,
                                                              (0.6137056388801096,): [c9]}},
                                               'mu5': {'nt_events': 1,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 0.5425528227705685,
                                                              (0.5425528227705685,): [c7]}},
                                               'mu6': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'nt_events': 3},
                                         'G': {'mu1': {'nt_events': 1,
                                                       (0,): {'nt_events': 1,
                                                              'region_weight': 1,
                                                              (None,): [g5]},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu2': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu3': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu4': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu5': {'nt_events': 0,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 0,
                                                              'region_weight': 0}},
                                               'mu6': {'nt_events': 1,
                                                       (0,): {'nt_events': 0,
                                                              'region_weight': 0},
                                                       (1,): {'nt_events': 1,
                                                              'region_weight': 4.722521458337745,
                                                              (4.722521458337745,): [g6]}},
                                               'nt_events': 2},
                                         'T': None},
                             'nt_events': 6}}}
        self.assertEqual(exp_event_tree, self.sequence6.event_tree)

    def testUpdateNt(self):
        random.seed(4675)
        nt_to_mutate = self.sequence6.nt_sequence[8]
        selected_mutation = self.sim_on_branch6.get_substitution()
        new_state = str(selected_mutation[1])  # A
        self.sim_on_branch6.update_nucleotide_info(nt_to_mutate, new_state)

        expected_rates = {'A': 3.22641589531113e-06,
                          'C': 9.679247685933389e-07,
                          'G': None,
                          'T': 2.2939102862996395e-05}

        self.assertEqual('G', nt_to_mutate.state)
        self.assertEqual('C', nt_to_mutate.get_complement_state())
        self.assertEqual(expected_rates, nt_to_mutate.rates)

    def testGetParentClade(self):
        # Label each clade
        ch = 'a'
        for child_clade in self.sim_on_tree6.phylo_tree.find_clades(order='level'):
            child_clade.name = ch
            ch = chr(ord(ch) + 1)

        results = []
        for child_clade in self.sim_on_tree6.phylo_tree.find_clades(order='level'):
            result = self.sim_on_tree6.get_parent_clade(child_clade)
            results.append(result.name)

        expected = ['a', 'a', 'a', 'a', 'd', 'd']
        self.assertEqual(expected, results)

    def testTraverseTree(self):
        random.seed(9001)
        np.random.seed(9001)
        self.sim_on_tree6.traverse_tree(4)

        exp_sequences = ['ATGATGGCCCTAA', 'ATGATGGCCCTAA', 'ATGATGGCCCTAA',
                         'ATGATGGCCCTAA', 'ATGATGGCCCTAA', 'ATGATGGCCCTAA']

        res_sequences = []
        for clade in self.sim_on_tree6.phylo_tree.find_clades(order='level'):
            res_sequences.append(str(clade.sequence))
        self.assertEqual(exp_sequences, res_sequences)

    def testGetAlignment(self):
        expected = '>A \nATGATGGCCCTAA\n>B \nATGATGGCCCTAA\n>C \nATGATGGCCCTAA\n>D \nATGATGGCCCTAA\n'
        outfile = './seq6_output.txt'
        self.sim_on_tree6.get_alignment(outfile)
        with open(outfile) as result_handle:
            result = result_handle.read()
        os.remove(outfile)
        self.assertEqual(expected, result)


if __name__ == '__main__':
    unittest.main()
